---
name: decoder/fim-event/0

sources:
  - decoder/fim/0

metadata:
    module: wazuh-agent/fim/fim-event
    title: FIM Decoder event
    description: >
        Decodes FIM messages
    compatibility: >
        This decoder has been tested on Wazuh version 4.3.
    author:
        name: Wazuh, Inc.
        url: https://wazuh.com
        date: 2022/11/08
    references:
        - https://documentation.wazuh.com/current/proof-of-concept-guide/poc-file-integrity-monitoring.html
        - https://documentation.wazuh.com/current/user-manual/capabilities/file-integrity/index.html
        - https://documentation.wazuh.com/current/user-manual/reference/ossec-conf/syscheck.html
        - https://documentation.wazuh.com/current/user-manual/reference/daemons/wazuh-db.html#fim-entry
        - https://github.com/wazuh/wazuh/issues/13521

check:
  - ~json.type: +string_equal/event
  - ~json.data.path: +is_string
  - ~json.data.type: +is_string

normalize:
  - map:
      - ~do_save2: false

  - check:
      - ~json.data.type: +string_equal/added
    map:
      - ~do_save2: true
  - check:
      - ~json.data.type: +string_equal/modified
    map:
      - ~do_save2: true

  - check:
      - ~do_save2: +is_true
    map:
      - ~json.data.audit: +delete
      - ~json.data.content_changes: +delete
      - ~json.data.changed_attributes: +delete
      - ~json.data.hard_links: +delete
      - ~json.data.mode: +delete
      - ~json.data.old_attributes: +delete
      - ~json.data.type: +delete
      - ~json.data.tags: +delete
      - ~query: +concat/agent /$agent.id/ syscheck save2 /$~json.data
      - ~query_result: +wdb_query/$~query

  - check:
      - ~do_save2: +is_false
      - ~json.data.type: +string_equal/deleted
    map:
      - ~query: +concat/agent /$agent.id/ syscheck delete /$~json.data.path
      - ~query_result: +wdb_query/$~query
